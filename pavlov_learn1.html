<!doctype html>
<html lang="en">
<head>
  <title>minimal demo</title>

  <!-- CSS goes here -->
  <style>
    body {
      background-color: #FFF; /* example... */
    }
  </style>

  <!-- import convnetjs library -->
  <script src="pavlov_learn1.js"></script>

  <!-- javascript goes here -->
  <script type="text/javascript">

    var World = function () {
      this.clock = 0;
      this.initial_real_adc_value = "1";
      this.initial_target_adc_value = "151";
      this.initial_dac_value = "500";
      this.state = {
        dac_value: this.initial_dac_value,
        real_adc_value: this.initial_real_adc_value,
        target_adc_value: this.initial_target_adc_value
      };
      this.real_adc_value_num = parseInt(this.state.real_adc_value);
      this.dac_value_num = parseInt(this.state.dac_value);
      this.dac_value_num_max = 1000;
      this.dac_value_num_min = 1;
      this.adc_value_num_max = 200;
      this.adc_value_num_min = 1;

      this.agent = new Agent();
    };
    World.prototype = {
      dac_value_to_adc_value: function (dac_value_num) {
        this.dac_value_num += dac_value_num;
//        this.dac_value_num = dac_value_num;
        if (this.dac_value_num > this.dac_value_num_max) {
          this.dac_value_num = this.dac_value_num_max;
        } else if (this.dac_value_num < this.dac_value_num_min) {
          this.dac_value_num = this.dac_value_num_min;
        }

        if (this.dac_value_num <= 200) {
          this.real_adc_value_num = this.adc_value_num_min;
        } else if (this.dac_value_num > 600) {
          this.real_adc_value_num = this.adc_value_num_max;
        } else {
          this.real_adc_value_num = 200 / (600 - 200) * (this.dac_value_num - 200) + this.adc_value_num_min;
          this.real_adc_value_num = Math.floor(this.real_adc_value_num);
        }
      },

      reward: function (state1) {
        var ret = 0;

        if (state1.real_adc_value === state1.target_adc_value) {
          ret = 1;
        }

        return ret;
      },
      //reset state when state == "Prize"
      reset: function (state1) {
        var has_reset = false;

        if (state1.real_adc_value === state1.target_adc_value) {
          has_reset = true;
          this.real_adc_value_num = parseInt(this.initial_real_adc_value);
          this.dac_value_num = parseInt(this.initial_dac_value);
          this.state = {
            dac_value: this.initial_dac_value,
            real_adc_value: this.initial_real_adc_value,
            target_adc_value: this.initial_target_adc_value
          };
          console.log("...................World reset!");

        }

        return has_reset;
      },

      state0_to_state1: function (action0) {
        this.dac_value_to_adc_value(parseInt(action0));
        return {
          dac_value: this.dac_value_num.toString(),
          real_adc_value: this.real_adc_value_num.toString(),
          target_adc_value: this.initial_target_adc_value
        };
      },

      rule: function () {
        var state0 = this.state;
        var action0;
        var reward0;
        var state1;

        action0 = this.agent.forward(state0);
        state1 = this.state0_to_state1(action0);
        reward0 = this.reward(state1);
        this.agent.backward(reward0, state1);

//        if (this.clock % 300 === 0) {
          console.log(state0, action0, reward0, state1);
//        }

        this.state = state1;
        this.reset(state1);

      },

      tick: function () {
        this.clock++;
//        console.log("clock = ", this.clock);
        this.rule();
//        if (this.clock < 3) {
//          this.rule();
//        }
      }
    };

    var Agent = function (actionsDescribeAll) {
      actionsDescribeAll = ["-10", "-1", "1", "10"];
      var opt = {};
      opt.learning_steps_burnin = 100;
      opt.gamma = 0.1;
      opt.batch_experience_learn_size = 0;
      this.brain = new pavlov_learn.Brain(actionsDescribeAll, opt);
    };
    Agent.prototype = {
//      set_task:function(state0, actionreward){
//
//      }

      forward: function (state0) {
//        return "10";
        return this.brain.forward(state0);
      },
      backward: function (reward0, state1) {
        this.brain.backward(reward0, state1);
      }
    };

    function tick() {
      w.tick();
    }


    var w;
    function start() {
//      start_befor();

      w = new World();
      setInterval(tick, 100);

//      var a = [];
//      a.push(1);
//      a.push(2);
//      a.push(3);
//      a.shift();
//      a.push(4);
//      a.shift();
//      console.log("a", a, a[0], a[1]);


//      console.log("abc>bbc:", "cbc">"bbc");
//      console.log("abc=bbc:", "abc"==="abc");
//      console.log("abc<bbc:", "abc"<"bbc");
//      console.log("abc<bbc:", parseInt("abc"));
//      pavlov_learn.memory();
//      var opt = {};
//      opt.batch_experience_learn_size = 30;
//
//      var actionsDescribeAll = ["-100", "-10", "-1", "1", "10", "100"];
//      var brain = new pavlov_learn.Brain(actionsDescribeAll, opt);
//      brain.forward({adc: 1, dac: 2});
//      brain.backward(0, {adc: 1, dac: 3});

    }

  </script>
</head>

<body onload="start()">
<div id="egdiv"></div>
</body>
</html>

